"""Sub Agents - Agents as Tools íŒ¨í„´ì„ ìœ„í•œ í•˜ìœ„ ì—ì´ì „íŠ¸ë“¤"""
from strands import Agent, tool
from strands_tools import http_request
from mcp_tools import get_position, wikipedia_search, duckduckgo_search
from model_config import get_configured_model
from typing import Dict, Any


# Search Agent - ì§€ëŠ¥ì  ê²€ìƒ‰ ë„êµ¬ ì„ íƒ
SEARCH_AGENT_PROMPT = """
ë‹¹ì‹ ì€ ì§€ëŠ¥ì  ê²€ìƒ‰ ì „ë¬¸ ì—ì´ì „íŠ¸ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ ê²€ìƒ‰ ìš”ì²­ì„ ë¶„ì„í•˜ì—¬ ê°€ì¥ ì í•©í•œ ê²€ìƒ‰ ë„êµ¬ë¥¼ ì„ íƒí•˜ê³  ì‚¬ìš©í•©ë‹ˆë‹¤.

ğŸ” ê²€ìƒ‰ ë„êµ¬ ì„ íƒ ì „ëµ:

1. **WIKIPEDIA ìš°ì„  ì‚¬ìš© ì¼€ì´ìŠ¤:**
   - ì—­ì‚¬ì  ì‚¬ì‹¤, ì¸ë¬¼, ì§€ì—­, êµ­ê°€ ì •ë³´
   - ê³¼í•™ì  ê°œë…, í•™ìˆ ì  ë‚´ìš©
   - ì˜ ì •ë¦½ëœ ì£¼ì œì˜ í¬ê´„ì  ì„¤ëª…
   - ì˜ˆ: "ì•„ì¸ìŠˆíƒ€ì¸", "í”„ë‘ìŠ¤", "ì–‘ìì—­í•™", "ë¥´ë„¤ìƒìŠ¤"

2. **DUCKDUCKGO ìš°ì„  ì‚¬ìš© ì¼€ì´ìŠ¤:**
   - ê¸°ìˆ  ìš©ì–´ ì •ì˜, í”„ë¡œê·¸ë˜ë° ê°œë…
   - ìµœì‹  íŠ¸ë Œë“œ, í˜„ëŒ€ì  ì£¼ì œ
   - ê°„ë‹¨í•œ ì •ì˜ë‚˜ ì„¤ëª…ì´ í•„ìš”í•œ ê²½ìš°
   - ì˜ˆ: "APIë€", "ë¨¸ì‹ ëŸ¬ë‹ ì •ì˜", "React í”„ë ˆì„ì›Œí¬"

3. **ì„ íƒ ì›ì¹™:**
   - ë¨¼ì € í•˜ë‚˜ì˜ ë„êµ¬ë§Œ ì‚¬ìš©í•˜ì—¬ ê²€ìƒ‰
   - ê²°ê³¼ê°€ ë¶ˆì¶©ë¶„í•˜ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ë‹¤ë¥¸ ë„êµ¬ ì¶”ê°€ ì‚¬ìš©
   - ë‘ ë„êµ¬ ëª¨ë‘ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ìµœí›„ì˜ ìˆ˜ë‹¨

4. **ê²°ê³¼ í‰ê°€:**
   - ê²€ìƒ‰ ê²°ê³¼ì˜ í’ˆì§ˆê³¼ ì™„ì„±ë„ë¥¼ í‰ê°€
   - ì‚¬ìš©ì ì§ˆë¬¸ì— ì¶©ë¶„íˆ ë‹µë³€í•  ìˆ˜ ìˆëŠ”ì§€ íŒë‹¨
   - í•„ìš”ì‹œì—ë§Œ ë³´ì™„ ê²€ìƒ‰ ì‹¤í–‰

ê²€ìƒ‰ í›„ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ì—¬ ì‚¬ìš©ìê°€ ì´í•´í•˜ê¸° ì‰½ê²Œ ìš”ì•½í•˜ê³ , ì–´ë–¤ ê²€ìƒ‰ ë„êµ¬ë¥¼ ì‚¬ìš©í–ˆëŠ”ì§€ ëª…ì‹œí•˜ì„¸ìš”.
"""

@tool
def search_agent(query: str) -> str:
    """
    ì§€ëŠ¥ì  ê²€ìƒ‰ ë„êµ¬ ì„ íƒì„ í†µí•œ ìµœì í™”ëœ ì •ë³´ ê²€ìƒ‰ ì—ì´ì „íŠ¸
    
    Args:
        query: ê²€ìƒ‰í•  ë‚´ìš©
        
    Returns:
        ì„ íƒëœ ê²€ìƒ‰ ë„êµ¬ë¥¼ í†µí•œ ìµœì í™”ëœ ë‹µë³€
    """
    try:
        agent = Agent(
            model=get_configured_model(),
            system_prompt=SEARCH_AGENT_PROMPT,
            tools=[wikipedia_search, duckduckgo_search]
        )
        
        search_prompt = f"""
        ì‚¬ìš©ì ê²€ìƒ‰ ìš”ì²­: "{query}"
        
        ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¼ ê²€ìƒ‰ì„ ìˆ˜í–‰í•˜ì„¸ìš”:
        
        1. **ìš”ì²­ ë¶„ì„**: ì´ ê²€ìƒ‰ ìš”ì²­ì˜ ì„±ê²©ì„ íŒŒì•…í•˜ì„¸ìš”
           - ì—­ì‚¬ì /í•™ìˆ ì  ë‚´ìš©ì¸ê°€?
           - ê¸°ìˆ ì  ì •ì˜ë‚˜ í˜„ëŒ€ì  ì£¼ì œì¸ê°€?
           - í¬ê´„ì  ì„¤ëª…ì´ í•„ìš”í•œê°€, ê°„ë‹¨í•œ ì •ì˜ë©´ ì¶©ë¶„í•œê°€?
        
        2. **ë„êµ¬ ì„ íƒ**: ë¶„ì„ ê²°ê³¼ì— ë”°ë¼ ê°€ì¥ ì í•©í•œ ë„êµ¬ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”
           - Wikipedia: í¬ê´„ì ì´ê³  ê¶Œìœ„ìˆëŠ” ì •ë³´ê°€ í•„ìš”í•œ ê²½ìš°
           - DuckDuckGo: ë¹ ë¥¸ ì •ì˜ë‚˜ í˜„ëŒ€ì  ì£¼ì œì¸ ê²½ìš°
        
        3. **ê²€ìƒ‰ ì‹¤í–‰**: ì„ íƒí•œ ë„êµ¬ë¡œ ê²€ìƒ‰ì„ ìˆ˜í–‰í•˜ì„¸ìš”
        
        4. **ê²°ê³¼ í‰ê°€**: ê²€ìƒ‰ ê²°ê³¼ê°€ ì‚¬ìš©ì ì§ˆë¬¸ì— ì¶©ë¶„íˆ ë‹µë³€í•˜ëŠ”ì§€ í‰ê°€í•˜ì„¸ìš”
           - ì¶©ë¶„í•˜ë‹¤ë©´: ê²°ê³¼ë¥¼ ì •ë¦¬í•˜ì—¬ ë‹µë³€
           - ë¶ˆì¶©ë¶„í•˜ë‹¤ë©´: ë‹¤ë¥¸ ë„êµ¬ë¡œ ë³´ì™„ ê²€ìƒ‰ ìˆ˜í–‰
        
        5. **ìµœì¢… ë‹µë³€**: 
           - ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì‚¬ìš©ì ì¹œí™”ì ìœ¼ë¡œ ìš”ì•½
           - ì‚¬ìš©í•œ ê²€ìƒ‰ ë„êµ¬ ëª…ì‹œ (ì˜ˆ: "Wikipediaì— ë”°ë¥´ë©´...", "DuckDuckGo ê²€ìƒ‰ ê²°ê³¼...")
           - í•„ìš”ì‹œ ë‘ ë„êµ¬ì˜ ê²°ê³¼ë¥¼ ì¢…í•©
        
        ì¤‘ìš”: ì²˜ìŒë¶€í„° ë‘ ë„êµ¬ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. í•˜ë‚˜ì”© ìˆœì°¨ì ìœ¼ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.
        """
        
        response = agent(search_prompt)
        return str(response)
        
    except Exception as e:
        return f"ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"


# Weather Agent - ë‚ ì”¨ ì •ë³´ ì „ë¬¸
WEATHER_AGENT_PROMPT = """
ë‹¹ì‹ ì€ ë‚ ì”¨ ì •ë³´ ì „ë¬¸ ì—ì´ì „íŠ¸ì…ë‹ˆë‹¤.
ì‚¬ìš©ìê°€ íŠ¹ì • ì§€ì—­ì˜ ë‚ ì”¨ë¥¼ ìš”ì²­í•˜ë©´, ë¨¼ì € í•´ë‹¹ ì§€ì—­ì˜ ì¢Œí‘œë¥¼ ì°¾ê³ 
National Weather Service APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚ ì”¨ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
ë¯¸êµ­ ì§€ì—­ë§Œ ì§€ì›ë©ë‹ˆë‹¤.
"""

@tool
def weather_agent(location_query: str) -> str:
    """
    íŠ¹ì • ì§€ì—­ì˜ ë‚ ì”¨ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ì „ë¬¸ ì—ì´ì „íŠ¸
    
    Args:
        location_query: ë‚ ì”¨ë¥¼ ì•Œê³  ì‹¶ì€ ì§€ì—­
        
    Returns:
        í•´ë‹¹ ì§€ì—­ì˜ ë‚ ì”¨ ì •ë³´
    """
    try:
        agent = Agent(
            model=get_configured_model(),
            system_prompt=WEATHER_AGENT_PROMPT,
            tools=[get_position, http_request]
        )
        
        weather_prompt = f"""
        "{location_query}" ì§€ì—­ì˜ ë‚ ì”¨ ì •ë³´ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.
        
        ë‹¨ê³„:
        1. ë¨¼ì € ì§€ì—­ì˜ ì •í™•í•œ ì¢Œí‘œ(ìœ„ë„, ê²½ë„)ë¥¼ ì°¾ìœ¼ì„¸ìš”
        2. ì¢Œí‘œê°€ ë¯¸êµ­ ì§€ì—­ì¸ì§€ í™•ì¸í•˜ì„¸ìš” (ìœ„ë„: 24-49, ê²½ë„: -125 ~ -66)
        3. ë¯¸êµ­ ì§€ì—­ì´ë©´ National Weather Service APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”
           - https://api.weather.gov/points/ìœ„ë„,ê²½ë„ í˜¸ì¶œ
           - ì‘ë‹µì—ì„œ forecast URL ì¶”ì¶œ
           - forecast URL í˜¸ì¶œí•˜ì—¬ ë‚ ì”¨ ì˜ˆë³´ ê°€ì ¸ì˜¤ê¸°
        4. ë¯¸êµ­ ì™¸ ì§€ì—­ì´ë©´ "ë¯¸êµ­ ì§€ì—­ë§Œ ì§€ì›í•©ë‹ˆë‹¤"ë¼ê³  ì•ˆë‚´í•˜ì„¸ìš”
        
        ì‚¬ìš©ì ì¹œí™”ì ì¸ ë‚ ì”¨ ë³´ê³ ì„œë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.
        """
        
        response = agent(weather_prompt)
        return str(response)
        
    except Exception as e:
        return f"ë‚ ì”¨ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"


# Conversation Agent - ì¼ë°˜ ëŒ€í™” ì „ë¬¸
CONVERSATION_AGENT_PROMPT = """
ë‹¹ì‹ ì€ ì¹œê·¼í•˜ê³  ë„ì›€ì´ ë˜ëŠ” ëŒ€í™” ì „ë¬¸ ì—ì´ì „íŠ¸ì…ë‹ˆë‹¤.
ê²€ìƒ‰ì´ë‚˜ ë‚ ì”¨ê°€ ì•„ë‹Œ ì¼ë°˜ì ì¸ ëŒ€í™”, ì¸ì‚¬, ì§ˆë¬¸ì— ëŒ€í•´ ìì—°ìŠ¤ëŸ½ê³  ìœ ìš©í•œ ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤.
ì‚¬ìš©ìì™€ ì¹œê·¼í•œ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ë©° í•„ìš”ì‹œ ì¡°ì–¸ì´ë‚˜ ì •ë³´ë¥¼ ì œê³µí•˜ì„¸ìš”.
"""

@tool
def conversation_agent(message: str) -> str:
    """
    ì¼ë°˜ì ì¸ ëŒ€í™”ì™€ ì§ˆë¬¸ì— ì‘ë‹µí•˜ëŠ” ì „ë¬¸ ì—ì´ì „íŠ¸
    
    Args:
        message: ì‚¬ìš©ìì˜ ë©”ì‹œì§€ë‚˜ ì§ˆë¬¸
        
    Returns:
        ìš”ì²­ì— ì‘ë‹µì˜ ì–‘ì‹ì´ ìˆë‹¤ë©´ ìš”ì²­ì‘ë‹µì— ë”°ë¥´ë©°, ì—†ë‹¤ë©´ ë„ì›€ì´ ë˜ëŠ” ë‹µë³€.
    """
    try:
        agent = Agent(
            model=get_configured_model(),
            system_prompt=CONVERSATION_AGENT_PROMPT,
            tools=[]
        )
        
        conversation_prompt = f"""
        ì‚¬ìš©ìê°€ ë‹¤ìŒê³¼ ê°™ì´ ì…ë ¥í•˜ì˜€ìŠµë‹ˆë‹¤: "{message}" 
        """
        
        response = agent(conversation_prompt)
        return str(response)
        
    except Exception as e:
        return f"ëŒ€í™” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
